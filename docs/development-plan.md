# 開発計画

## 概要

麻雀点数記録アプリの開発計画書。従来のスプレッドシートでの点数記録をWebアプリケーション化する。

## 技術スタック

- **フレームワーク**: Next.js (App Router)
- **スタイル**: Tailwind CSS
- **UIライブラリ**: shadcn/ui
- **DB・認証**: Supabase
- **デザイン方針**: モバイルファースト

---

## フェーズ1: プロジェクト基盤構築

**目標**: 開発環境のセットアップと基本的なプロジェクト構成の確立

### タスク

|#|タスク|詳細|
|---|---|---|
|1-1|Next.jsプロジェクト作成|App Router、TypeScript、Tailwind CSS の設定|
|1-2|shadcn/ui導入|必要なコンポーネントのインストール（Button, Input, Card, Dialog, Toast等）|
|1-3|Supabaseプロジェクト作成|プロジェクト作成、API キーの取得|
|1-4|環境変数設定|`.env.local` の設定（Supabase URL, API Key）|
|1-5|ディレクトリ構成作成|設計に基づくフォルダ構成の作成|
|1-6|Supabaseクライアント設定|`lib/supabase/client.ts`, `lib/supabase/server.ts` の作成|

### 成果物

- 動作するNext.jsプロジェクト
- shadcn/uiコンポーネントが利用可能な状態
- Supabase接続の確立

---

## フェーズ2: データベース設計・構築

**目標**: Supabaseでのデータベーススキーマ構築とRLSポリシーの設定

Supabase CLIを利用する。

### タスク

|#|タスク|詳細|
|---|---|---|
|2-1|usersテーブル作成|id, display_name, password_hash, is_admin, created_at, updated_at, deleted_at（論理削除用）|
|2-2|sectionsテーブル作成|id, name, starting_points, return_points, rate, player_count, status, created_by, created_at, closed_at|
|2-3|section_participantsテーブル作成|id, section_id, user_id, created_at|
|2-4|gamesテーブル作成|id, section_id, game_number, created_at, updated_at|
|2-5|scoresテーブル作成|id, game_id, user_id, points, created_at, updated_at|
|2-6|外部キー制約設定|各テーブル間のリレーション設定（ユーザー削除は論理削除のためCASCADEなし）|
|2-7|インデックス作成|必要最小限のインデックス（section_participants、scoresの外部キーのみ）|
|2-8|RLSポリシー設定|行レベルセキュリティの設定|
|2-9|初期データ投入|管理者ユーザーの作成|

### 設計方針

#### ユーザー削除について
- **論理削除を採用**: `deleted_at`カラムで削除状態を管理
- 削除されたユーザーのスコア履歴は保持される
- 削除済みユーザーは一覧に表示されないが、過去のセクション・スコアには名前が残る

#### 外部キー制約
| 子テーブル | 外部キー | 親テーブル | 削除時の動作 |
|---|---|---|---|
| `sections` | `created_by` | `users.id` | `SET NULL` |
| `section_participants` | `section_id` | `sections.id` | `CASCADE` |
| `section_participants` | `user_id` | `users.id` | `RESTRICT`（論理削除のため物理削除不可） |
| `games` | `section_id` | `sections.id` | `CASCADE` |
| `scores` | `game_id` | `games.id` | `CASCADE` |
| `scores` | `user_id` | `users.id` | `RESTRICT`（論理削除のため物理削除不可） |

#### インデックス（必要最小限）
- `section_participants(section_id)` - セクション参加者取得用
- `section_participants(user_id)` - ユーザーの参加セクション取得用
- `scores(game_id)` - ゲームのスコア取得用
- `scores(user_id)` - ユーザーの統計計算用

※ `sections.status`や`sections.created_at`へのインデックスは、データ量が増えて必要になった段階で追加

### 成果物

- 全テーブルの作成完了
- RLSポリシーの設定完了
- 初期管理者アカウント

---

## フェーズ3: 認証機能

**目標**: ログイン・ログアウト機能とセッション管理の実装

### タスク

|#|タスク|詳細|
|---|---|---|
|3-1|ログインページUI作成|`app/(auth)/login/page.tsx` - 表示名・パスワード入力フォーム|
|3-2|認証Server Actions作成|`app/(auth)/actions.ts` - login, logout関数|
|3-3|セッション管理ユーティリティ|`lib/auth/session.ts` - getSession, createSession関数|
|3-4|Middleware作成|`middleware.ts` - 認証状態によるリダイレクト制御|
|3-5|認証状態の保持|Cookieベースのセッション管理|
|3-6|パスワードハッシュ化|bcrypt等を使用したパスワードのハッシュ化処理|

### 成果物

- ログイン・ログアウト機能
- セッション管理機能
- 認証ルート保護

---

## フェーズ4: 共通レイアウト・コンポーネント

**目標**: アプリ全体で使用する共通UIの実装

### タスク

|#|タスク|詳細|
|---|---|---|
|4-1|認証済みレイアウト作成|`app/(main)/layout.tsx` - ヘッダー、ナビゲーション|
|4-2|ヘッダーコンポーネント|ロゴ、ナビゲーションリンク、ユーザーメニュー|
|4-3|ナビゲーション|セクション一覧、雀士一覧、統計へのリンク|
|4-4|ユーザーメニュー|アカウント設定、ログアウトへのリンク|
|4-5|トースト通知設定|成功・エラー通知の共通設定|
|4-6|ローディングUI|各ページのローディング状態表示|
|4-7|エラーUI|エラーページの作成|

### 成果物

- 共通レイアウト
- ナビゲーション
- 通知システム

---

## フェーズ5: 雀士管理機能

**目標**: 雀士の一覧表示・作成・編集・削除機能の実装

### タスク

|#|タスク|詳細|
|---|---|---|
|5-1|クエリ関数作成|`lib/db/queries/users.ts` - getUsers, getUser|
|5-2|ミューテーション関数作成|`lib/db/mutations/users.ts` - createUser, updateUser, deleteUser|
|5-3|雀士一覧ページ|`app/(main)/users/page.tsx` - Server Component|
|5-4|雀士作成フォーム|表示名・パスワード入力（管理者のみ表示）|
|5-5|雀士編集機能|表示名の編集（管理者のみ）|
|5-6|雀士削除機能|確認ダイアログ付き削除（管理者のみ）|
|5-7|Server Actions作成|`app/(main)/users/actions.ts` - createUser, updateUser, deleteUser|
|5-8|権限チェック実装|管理者権限の検証|

### 成果物

- 雀士一覧ページ
- 雀士CRUD機能
- 管理者権限制御

---

## フェーズ6: セクション管理機能

**目標**: セクションの作成・一覧表示・編集・削除・終了機能の実装

セクション一覧はリアルタイム購読したい。

### タスク

|#|タスク|詳細|
|---|---|---|
|6-1|クエリ関数作成|`lib/db/queries/sections.ts` - getSections, getSectionWithGames|
|6-2|ミューテーション関数作成|`lib/db/mutations/sections.ts` - createSection, updateSection, closeSection, deleteSection|
|6-3|セクション一覧ページ|`app/(main)/sections/page.tsx` - Server Component|
|6-4|フィルター機能|進行中/終了済みのフィルタ|
|6-5|検索機能|セクション名・参加者での検索|
|6-6|ソート機能|作成日時での並び替え|
|6-7|セクション作成ページ|`app/(main)/sections/new/page.tsx`|
|6-8|セクション作成フォーム|名前、開始点、返し点、レート、参加人数、参加者選択|
|6-9|Server Actions作成|`app/(main)/sections/actions.ts` - createSection|
|6-10|バリデーション実装|参加人数（3〜4人）、必須項目チェック|

### 成果物

- セクション一覧ページ
- セクション作成機能
- フィルター・検索・ソート機能

### 未実装・課題

#### リアルタイム購読（未完了）

Supabaseのリアルタイム機能を使用したセクション一覧の自動更新は、以下の理由で正常に動作しなかった：

- **症状**: DELETEイベントのみ検知され、INSERT/UPDATEイベントが検知されない
- **試した対策**:
  1. `supabase_realtime` publicationへのテーブル追加
  2. `replica identity full` の設定
  3. Server Actionを使用したデータ再取得パターンへの変更
- **推定原因**: RLSポリシーの設定、またはSupabaseプロジェクトのリアルタイム設定に問題がある可能性

現状はリアルタイム購読のコードは実装済みだが、動作確認ができていない。将来的にSupabaseの設定を見直すか、ポーリングによる代替実装を検討する。

---

## フェーズ7: セクション詳細・ゲーム管理機能

**目標**: セクション詳細表示と点数入力・修正・削除機能の実装

点数はリアルタイム購読したい。

Supabaseリモートの設定とVercelプロジェクトの作成を行う。

### タスク

|#|タスク|詳細|
|---|---|---|
|7-1|クエリ関数作成|`lib/db/queries/games.ts` - getGames, getGameWithScores|
|7-2|ミューテーション関数作成|`lib/db/mutations/games.ts` - addGame, updateGame, deleteGame|
|7-3|セクション詳細ページ|`app/(main)/sections/[id]/page.tsx` - Server Component|
|7-4|スコアボード表示|スプレッドシート形式での点数一覧表示|
|7-5|集計表示|合計点、増減、精算額、順位の計算・表示|
|7-6|点数入力フォーム|各プレイヤーの点数入力（100点単位）|
|7-7|点数合計バリデーション|参加人数 × 開始点との一致チェック|
|7-8|点数修正機能|既存ゲームの点数修正（参加者のみ）|
|7-9|点数削除機能|ゲームの削除（作成者のみ）|
|7-10|セクション編集機能|名前、開始点、返し点、レートの編集|
|7-11|セクション終了機能|締め処理（作成者のみ）|
|7-12|Server Actions作成|`app/(main)/sections/[id]/actions.ts`|
|7-13|権限チェック実装|参加者・作成者の権限検証|

### 成果物

- セクション詳細ページ
- 点数入力・修正・削除機能
- 集計計算機能
- セクション終了機能

---

## フェーズ8: 統計機能

**目標**: 期間指定での統計表示機能の実装

### タスク

|#|タスク|詳細|
|---|---|---|
|8-1|クエリ関数作成|`lib/db/queries/stats.ts` - getStats, getUserStats|
|8-2|統計ページ|`app/(main)/stats/page.tsx` - Server Component|
|8-3|期間選択UI|全期間/今月/先月/カスタム期間の選択|
|8-4|勝率計算|1位の割合の計算・表示|
|8-5|平均順位計算|平均順位の計算・表示|
|8-6|通算収支計算|全精算額の合計の計算・表示|
|8-7|参加ゲーム数表示|参加ゲーム総数の表示|
|8-8|参加セクション数表示|参加セクション総数の表示|
|8-9|雀士比較表示|複数雀士の統計比較|

### 成果物

- 統計ページ
- 期間フィルター
- 各種統計指標の表示

---

## フェーズ9: アカウント設定機能

**目標**: ユーザー自身のアカウント設定機能の実装

### タスク

|#|タスク|詳細|
|---|---|---|
|9-1|アカウント設定ページ|`app/(main)/settings/page.tsx`|
|9-2|表示名変更フォーム|現在の表示名表示、新しい表示名入力|
|9-3|パスワード変更フォーム|現在のパスワード、新しいパスワード入力|
|9-4|Server Actions作成|`app/(main)/settings/actions.ts` - updateDisplayName, updatePassword|
|9-5|パスワード検証|現在のパスワードの検証|
|9-6|ログアウト機能|セッション破棄、ログインページへリダイレクト|

### 成果物

- アカウント設定ページ
- 表示名変更機能
- パスワード変更機能

---

## フェーズ10: UI/UX改善・レスポンシブ対応

**目標**: モバイルファーストでのUI改善とユーザビリティ向上

### タスク

|#|タスク|詳細|
|---|---|---|
|10-1|モバイルレイアウト調整|各ページのモバイル対応|
|10-2|タブレットレイアウト調整|中間サイズでの表示最適化|
|10-3|デスクトップレイアウト調整|大画面での表示最適化|
|10-4|フォーム入力改善|数値入力の最適化（テンキー表示等）|
|10-5|タッチ操作最適化|タップターゲットサイズの調整|
|10-6|ローディング状態改善|スケルトンローダーの実装|
|10-7|エラー表示改善|わかりやすいエラーメッセージ|
|10-8|成功フィードバック|操作完了時のトースト通知|

### 成果物

- レスポンシブ対応完了
- 改善されたユーザー体験

---

## フェーズ11: テスト・品質保証

**目標**: アプリケーションの品質担保

### タスク

|#|タスク|詳細|
|---|---|---|
|11-1|計算ロジックテスト|合計点、増減、精算額、順位の計算テスト|
|11-2|バリデーションテスト|点数合計チェック、入力値検証のテスト|
|11-3|権限チェックテスト|各操作の権限検証テスト|
|11-4|E2Eテスト|主要フローの動作確認|
|11-5|クロスブラウザテスト|主要ブラウザでの動作確認|
|11-6|パフォーマンステスト|ページ読み込み3秒以内、点数反映1秒以内の確認|
|11-7|セキュリティテスト|認証・認可の脆弱性チェック|

### 成果物

- テストコード
- 品質レポート

---

## フェーズ12: デプロイ・運用準備

**目標**: 本番環境へのデプロイと運用体制の構築

### タスク

|#|タスク|詳細|
|---|---|---|
|12-1|Vercelプロジェクト作成|Next.jsのホスティング設定|
|12-2|環境変数設定|本番環境の環境変数設定|
|12-3|ドメイン設定|カスタムドメインの設定（必要に応じて）|
|12-4|Supabase本番設定|本番環境のデータベース設定|
|12-5|バックアップ確認|Supabase自動バックアップの確認|
|12-6|監視設定|エラー監視、パフォーマンス監視の設定|
|12-7|本番デプロイ|初回デプロイの実施|
|12-8|動作確認|本番環境での最終動作確認|

### 成果物

- 本番環境へのデプロイ完了
- 運用体制の確立

---

## スケジュール概要

|フェーズ|目安期間|依存関係|
|---|---|---|
|フェーズ1: プロジェクト基盤構築|1日|-|
|フェーズ2: データベース設計・構築|1日|フェーズ1|
|フェーズ3: 認証機能|2日|フェーズ2|
|フェーズ4: 共通レイアウト・コンポーネント|1日|フェーズ3|
|フェーズ5: 雀士管理機能|2日|フェーズ4|
|フェーズ6: セクション管理機能|3日|フェーズ5|
|フェーズ7: セクション詳細・ゲーム管理機能|4日|フェーズ6|
|フェーズ8: 統計機能|2日|フェーズ7|
|フェーズ9: アカウント設定機能|1日|フェーズ4|
|フェーズ10: UI/UX改善・レスポンシブ対応|2日|フェーズ7|
|フェーズ11: テスト・品質保証|2日|フェーズ10|
|フェーズ12: デプロイ・運用準備|1日|フェーズ11|

**合計目安: 約22日（3〜4週間）**

---

## 備考

### 優先度について

- **必須**: フェーズ1〜7（基本機能）
- **重要**: フェーズ8〜9（統計・設定）
- **推奨**: フェーズ10〜12（品質・運用）

### 将来的な拡張（v2.0以降）

- ウマ・オカ対応
- プッシュ通知
- リアルタイム同期
- データエクスポート機能
